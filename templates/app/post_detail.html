{% extends 'base.html' %}

{% load static %}

{% block title %}
投稿詳細
{% endblock %}

{% block content %}

<h2>投稿詳細</h2>
{% if post_data.user == request.user %}
<form action="{% url 'app:post_delete' post_data.pk %}" method="post">
    {% csrf_token %}
    <a href="{% url 'app:post_edit' post_data.pk %}" class="btn btn-primary">編集</a>
    <button type="submit" class="btn btn-danger" onclick="return confirm('この投稿を削除してもよろしいでしょうか？')">削除</button>
</form>
{% endif %}
</div>


<p>{{ post_data.book_title }}</p>
<p>{{ post_data.post_title }}</p>
<p>{{ post_data.reason }}</p>
<p>{{ post_data.impressions }}</p>
<p>{{ post_data.satisfaction }}</p>


<div class="d-flex">
    <div class="">
        {% if post_data.user != request.user %}
        {% endif %}
        <button type="button" class="btn btn-success" data-bs-toggle="modal"
            data-bs-target="#openModal">本の情報を見る</button>
        <a href="{% url 'accounts:profile_detail' post_data.user.profile.username %}"
            class="btn btn-primary">投稿者プロフィール</a>
        <a href="{% url 'app:post_list' %}" class="btn btn-secondary">ホームに戻る</a>
    </div>
</div>


<div class="modal" tabindex="-1" id="openModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">本の情報</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img src="{{ book_data.image }}" alt="">
                <p>{{ book_data.title }}</p>
                <p>{{ book_data.author }}</p>
                <p>{{ book_data.salesDate }}</p>
                <p>{{ book_data.publisherName }}</p>
                <p>{{ book_data.size }}</p>
                <p>{{ book_data.itemCaption }}</p>

                <p>{{ book_data.reviewAverage }}</p>
                <p>{{ book_data.reviewCount }}</p>
                <a href="{{ book_data.itemUrl }}" target="_blank">販売ページを開く</a>
            </div>
        </div>
    </div>
</div>


<div class="">
    <h3 class="mb-3">コメント</h3>
    {% if comment_data %}
    <div class="">
        {% for comment in comment_data %}
        {% if comment.user.profile.image %}
        <img src="{{ comment.user.profile.image.url }}" alt="" style="width: 100px; height: 100px">
        {% else %}
        <img src="{% static 'accounts/user_image/default_image.jpeg' %}" alt="" style="width: 100px; height: 100px">
        {% endif %}
        <p>
            <a href="{% url 'accounts:profile_detail' comment.user.profile.username %}">
                {{ comment.user.profile.name }}さん
            </a>
            {{ comment.created_at }}<br>
            {{ comment.comment }}
        </p>
        {% if comment.user_id == request.user.id %}
        <form method="POST" action="{% url 'app:comment_delete' pk=post_data.pk comment_id=comment.pk %}">
            {% csrf_token %}
            <button class="btn btn-outline-danger" type="submit" onclick='return confirm("本当に削除しますか？");'>削除</button>
        </form>
        {% endif %}
        <hr>
        {% endfor %}
    </div>


    <nav aria-label="Page navigation">
        {% if comment_data.has_other_pages %}
        <ul class="pagination justify-content-center">
            {% if comment_data.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">最初</a></li>
            {% else %}
            <li class="page-item disable"><span class="page-link text-secondary">最初</span></li>
            {% endif %}

            {% if comment_data.number|add:'-2' > 1 %}
            <li class="page-item"><a class="page-link" href="?page={{ comment_data.number|add:'-2' }}">&hellip;</a></li>
            {% endif %}

            {% for i in comment_data.paginator.page_range %}
            {% if comment_data.number == i %}
            <li class="page-item active"><span class="page-link">{{ i }}<span class="visually-hidden"></span></li>
            {% elif i > comment_data.number|add:'-2' and i < comment_data.number|add:'2' %} <li class="page-item"><a
                    class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                {% endif %}
                {% endfor %}

                {% if comment_data.paginator.num_pages > comment_data.number|add:'2' %}
                <li><a class="page-link" href="?page={{ comment_data.number|add:'2' }}">&hellip;</a></li>
                <li><a href="?page={{ i }}">{{ i }}</a></li>
                <li><a class="page-link" href="?page={{ comment_data.paginator.num_pages }}">{{
                        comment_data.paginator.num_pages
                        }}</a></li>
                {% endif %}

                {% if comment_data.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ comment_data.paginator.num_pages }}">最後</a>
                </li>
                {% else %}
                <li class="page-item disable"><span class="page-link text-secondary">最後</span></li>
                {% endif %}
        </ul>
        {% endif %}
    </nav>
    {% else %}
    <p>コメントはありません。</p>
    {% endif %}


    <div class="">
        {% if request.user.is_authenticated and not post_data.user_id == request.user.id %}
        <form method="POST" action="{% url 'app:comment_new' post_data.pk %}">
            {% csrf_token %}
            {% if field.errors %}
            <div class="error">
                {% for error in field.errors %}
                <p class="text-danger">※{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            {{ comment_form.as_p }}
            <button type="submit" class="btn btn-outline-success">送信</button>
        </form>
        {% endif %}
    </div>
</div>


{% endblock %}
